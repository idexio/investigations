26 Dec 2021

# Overview

An exploit reported via IDEX’s bug bounty program revealed a vulnerability in the Silverton (IDEX v3) liquidity removal logic. Liquidity removals from pools where the price is significantly less than one sometimes distributed more quote reserve quantity than expected. An internal analysis determined the root cause as a numerical precision design flaw, where the removal quantity calculations did not sufficiently account for the precision limits of the system.

A temporary mitigation measure was implemented that prevented any further LP losses followed by a permanent fix via smart contract upgrade.

This document discusses the underlying issue and fix in detail, see the [incident report](https://medium.com/idex/idex-lp-critical-fix-smart-contract-upgrade-dae7291e87f8) for broader context.

# Problem

Silverton’s liquidity removal uses a different approach than other AMMs when computing base and quote reserve removal quantities. As noted in the [documentation](https://github.com/idexio/idex-contracts-silverton#liquidity-removal), liquidity pools must maintain constant [pip-precision](https://github.com/idexio/idex-contracts-silverton#precision-and-pips) pricing during a removal. As such, [the base quantity is computed from the liquidity to total liquidity ratio, and the quote is computed from the removed base and pool’s price](https://github.com/idexio/idex-contracts-silverton/blob/86468b37ee45a08c7b0f6de4ba0e61879542e69b/contracts/libraries/LiquidityPoolHelpers.sol#L49).

Silverton’s markets are directional with a defined base and quote, and as a result, pool pricing is also defined in one direction:

```
pool price = quote reserve quantity / base reserve quantity
```

When pool pricing is more than one, there is a greater quantity of quote reserves than base reserves and the pool price contains many digits of precision within pip representation limits. When the price is less than one, however, the pool price contains relatively few digits of precision. See the [pricing example](https://docs.google.com/spreadsheets/d/1WLoLoWLiK91VcUY4NrDjwo8NRKud1cqTbKkr2fp_OVg/edit#) for a model:


* The MATIC-USDC pool is priced over one at 2.33198713, so there are 9 digits within pip-representation limits.
* The MATIC-ETH pool is priced under one at 0.00057693, so there are only 5 digits within pip-representation limits.

_Note: The model spreadsheet has number formatting applied to highlight pip-precision limits. The value after the 8th decimal and space is included to illustrate values used in calculations that must be truncated afterwards._

As noted above, liquidity removal quote reserve quantity is calculated from the removal base quantity and pool price:
```
new base reserve quantity = base reserve quantity - base removal quantity
quote removal quantity = quote reserve quantity - (new base quantity  pool price)
```
Importantly, the pool price is truncated to single pip precision. In the [example model](https://docs.google.com/spreadsheets/d/1WLoLoWLiK91VcUY4NrDjwo8NRKud1cqTbKkr2fp_OVg/edit#), removing 10 MATIC removes 23.71148571 of USDC, which is several tenths of a penny higher than the expected value. This small difference expands to a much larger difference in removed quote when the pool price is less than one. A similar example removal of 10 MATIC from the MATIC-ETH market using single pip precision pool pricing removes 0.01109913 ETH, which is nearly 50% higher than the expected ETH removal quantity.

The use of single pip precision pricing in the quote removal quantity formula changes the sub-pip precision price of pools on removals. The change is not significant for most pools, however, it can be significant when pool price is much less than one. 

* In the MATIC-ETH example, the single pip precision price is 0.0000000086487648 lower than the double pip precision price.
* The removal quote quantity formula inadvertently lowers the pool price to 0.0005769300000000 rather than its initial 0.0005769386487649.

Lowering the pool price requires removing more quote quantity than base quantity. As a result, when pool prices happen not to be pip-aligned, a removal pays out a greater-than-expected quantity of quote reserves to the removing wallet.

# Mitigation

IDEX implemented a temporary mitigation measure shortly after completing bug analysis. Liquidity removals only remove a greater-than-expected quote quantity when pool prices are not pip-aligned. With the mitigation, IDEX off-chain software detects when a pool enters this state and adds base reserves to the pool. The quantity of added base reserves is computed to return the pool price to a pip-aligned value.

* For example, the mitigation logic proactively adds MATIC to the above MATIC-ETH pool to reduce the price from 0.0005769386487649 to 0.0005769300000000 prior to any removals.
* Subsequent removals then do not remove more ETH from the pool than expected.

While this solution protects LP funds, it requires IDEX to contribute company treasury to pool liquidity. LP token minting logic does not credit IDEX for the surplus contribution, however, so those funds are permanently distributed to existing LP holders.

# Permanent Solution

Silverton’s smart contracts include an upgrade mechanism, but the upgrade mechanism requires a 72 hour governance delay. With the temporary mitigation in place, IDEX developed a permanent solution involving a smart contract logic update.

While Silverton wallet and pool balances are stored in pip precision, it is possible to use higher precision in other parts of the logic. Increasing the precision of the `pool price` term of the quote removal quantity formula from single pip precision to double pip precision eliminates excess quote reserve removals. From the [example model](https://docs.google.com/spreadsheets/d/1WLoLoWLiK91VcUY4NrDjwo8NRKud1cqTbKkr2fp_OVg/edit#), note that the `Quote removal quantity (double pip price)` values match the expected values with a single pip rounding difference on MATIC-USDC and an exact match on MATIC-ETH.

A permanent solution required updates to both off-chain and on-chain logic.

## Off-Chain Updates

* Silverton’s matching engine uses double precision pricing when computing the quote removal quantity.

## On-Chain Updates

* The removal validation logic [confirms the base removal quantity](https://github.com/idexio/idex-contracts-silverton/blob/94fc85f9d33c141035ab7f8567ff0ebe3e1149ce/contracts/libraries/LiquidityChangeExecutionValidations.sol#L162) and [overall pool price stability](https://github.com/idexio/idex-contracts-silverton/blob/94fc85f9d33c141035ab7f8567ff0ebe3e1149ce/contracts/libraries/LiquidityPools.sol#L297).
* The `removeLiquidityExit` logic [uses double precision pricing](https://github.com/idexio/idex-contracts-silverton/blob/94fc85f9d33c141035ab7f8567ff0ebe3e1149ce/contracts/libraries/LiquidityPoolHelpers.sol#L59) when computing the quote removal quantity.
* A new `upgradeLiquidityPool` function [migrates pool state](https://github.com/idexio/idex-contracts-silverton/blob/94fc85f9d33c141035ab7f8567ff0ebe3e1149ce/contracts/Exchange.sol#L839) from previous Exchange contracts.
* `signatureHashVersion` is [incremented to 4](https://github.com/idexio/idex-contracts-silverton/blob/94fc85f9d33c141035ab7f8567ff0ebe3e1149ce/contracts/libraries/Constants.sol#L46) to eliminate the possibility of replay attacks.

All permanent fix measures have been completed and deployed to the mainnet application.

# LP Compensation

This repo contains a script and transaction source data to compute the LP losses resulting from the removal vulnerability. The inputs and outputs are also available as a [sheet](https://docs.google.com/spreadsheets/d/1y3wSEvx6k8xaLx08KXf08LcmklGTjRLrzu1bxXMcNIA/edit#gid=978523623). The results do not account for the funds IDEX permanently contributed to LPs during mitigation. LP losses above 0.01 USD have been compensated by the company via air drop.
